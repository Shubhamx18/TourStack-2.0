name: CI-CD-K8S

on:
  push:
    branches:
      - main

jobs:
  build-push-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ap-south-1

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_wrapper: false

      - name: Terraform Init
        working-directory: terraform
        run: terraform init

      - name: Import Existing Infra (Ignore if not exists)
        working-directory: terraform
        run: |
          terraform import aws_iam_role.eks_cluster_role eks-cluster-role-tourstack-eks || true
          terraform import aws_iam_role.node_group_role eks-node-group-role-tourstack-eks || true
          terraform import aws_eks_cluster.main tourstack-eks || true
          terraform import aws_eks_node_group.main tourstack-eks:tourstack-nodes || true
          terraform import aws_iam_role_policy_attachment.eks_cluster_policy eks-cluster-role-tourstack-eks/arn:aws:iam::aws:policy/AmazonEKSClusterPolicy || true
          terraform import aws_iam_role_policy_attachment.node_worker_policy eks-node-group-role-tourstack-eks/arn:aws:iam::aws:policy/AmazonEKSWorkerNodePolicy || true
          terraform import aws_iam_role_policy_attachment.node_cni_policy eks-node-group-role-tourstack-eks/arn:aws:iam::aws:policy/AmazonEKS_CNI_Policy || true
          terraform import aws_iam_role_policy_attachment.node_ecr_policy eks-node-group-role-tourstack-eks/arn:aws:iam::aws:policy/AmazonEC2ContainerRegistryReadOnly || true
          terraform import aws_key_pair.eks_nodes eks-nodes-tourstack-eks || true
          SG_ID=$(aws ec2 describe-security-groups \
            --filters "Name=group-name,Values=eks-nodes-open-tourstack-eks" "Name=vpc-id,Values=vpc-0ab1cf9e189e2c9e7" \
            --query "SecurityGroups[0].GroupId" \
            --output text \
            --region ap-south-1)
          if [ "$SG_ID" != "None" ] && [ -n "$SG_ID" ]; then
            terraform import aws_security_group.eks_nodes_open $SG_ID || true
          fi

      - name: Terraform Apply
        working-directory: terraform
        run: terraform apply -auto-approve

      - name: Get Cluster Name
        working-directory: terraform
        run: |
          CLUSTER_NAME=$(terraform output -raw cluster_name)
          echo "CLUSTER_NAME=$CLUSTER_NAME" >> $GITHUB_ENV

      - name: Save SSH Key
        working-directory: terraform
        run: |
          terraform output -raw ssh_private_key > eks-nodes.pem
          chmod 400 eks-nodes.pem
          echo "====== COPY THIS PRIVATE KEY ======"
          cat eks-nodes.pem
          echo "====== END OF PRIVATE KEY ======"

      - name: Get Node Public IPs
        run: |
          echo "====== NODE PUBLIC IPs ======"
          aws ec2 describe-instances \
            --filters "Name=tag:eks:nodegroup-name,Values=tourstack-nodes" \
            --query "Reservations[*].Instances[*].PublicIpAddress" \
            --output text \
            --region ap-south-1
          echo "====== END OF NODE IPs ======"

      - name: Install kubectl
        run: |
          curl -o kubectl https://s3.us-west-2.amazonaws.com/amazon-eks/1.29.0/2024-01-04/bin/linux/amd64/kubectl
          chmod +x ./kubectl
          sudo mv ./kubectl /usr/local/bin

      - name: Update kubeconfig for EKS
        run: |
          aws eks update-kubeconfig \
            --region ap-south-1 \
            --name ${{ env.CLUSTER_NAME }}

      - name: Login to DockerHub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build and Push Backend
        uses: docker/build-push-action@v5
        with:
          context: ./backend
          push: true
          tags: ${{ secrets.DOCKERHUB_USERNAME }}/tourstack-backend:latest

      - name: Build and Push Frontend
        uses: docker/build-push-action@v5
        with:
          context: ./frontend
          push: true
          tags: ${{ secrets.DOCKERHUB_USERNAME }}/tourstack-frontend:latest

      - name: Deploy to EKS
        run: |
          sed -i "s|yourusername|${{ secrets.DOCKERHUB_USERNAME }}|g" k8s/backend-deployment.yaml
          sed -i "s|yourusername|${{ secrets.DOCKERHUB_USERNAME }}|g" k8s/frontend-deployment.yaml

          kubectl apply -f k8s/namespace.yaml
          kubectl apply -f k8s/mysql-pvc.yaml
          kubectl apply -f k8s/mysql-deployment.yaml
          kubectl apply -f k8s/backend-deployment.yaml
          kubectl apply -f k8s/frontend-deployment.yaml

          kubectl rollout restart deployment/backend -n tourstack
          kubectl rollout restart deployment/frontend -n tourstack

          kubectl rollout status deployment/backend -n tourstack
          kubectl rollout status deployment/frontend -n tourstack

      - name: Get Service URLs
        run: |
          echo "====== SERVICE URLS ======"
          kubectl get svc -n tourstack
          echo "====== END ======"
